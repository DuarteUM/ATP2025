import numpy as np
import json
import os

# Constantes
CHEGADA = "chegada"
SAIDA = "saída"

# --- Funções de Suporte ---
def e_tempo(e): return e[0]
def e_tipo(e): return e[1]
def e_doente(e): return e[2]

def procuraPosQueue(q, t):
    i = 0
    while i < len(q) and t > q[i][0]: i += 1
    return i

def enqueue(q, e):
    pos = procuraPosQueue(q, e[0])
    return q[:pos] + [e] + q[pos:]

def dequeue(q):
    return q[0], q[1:]

def mOcupa(m):
    m[1] = not m[1]
    return m

def gera_proxima_chegada_poisson(taxa_lmbda):
    return np.random.exponential(1.0 / taxa_lmbda)

def gera_tempo_consulta(mean_service_time, dist):
    if dist == "exponential": return np.random.exponential(mean_service_time)
    elif dist == "normal": return max(1, np.random.normal(mean_service_time, mean_service_time / 3))
    return mean_service_time

# --- Função Principal ---
def simula(num_medicos, taxa_chegada, tempo_medio_consulta, tempo_simulacao, dist_tempo_consulta="exponential", caminho_json="pessoas (1).json", debug=False):
    
    # Carregar JSON com verificação de erro
    if os.path.exists(caminho_json):
        with open(caminho_json, 'r', encoding='utf-8') as f:
            lista_pessoas = json.load(f)
    else:
        print(f"AVISO: Ficheiro {caminho_json} não encontrado! A usar nomes genéricos.")
        lista_pessoas = [{"nome": f"Doente_{i}", "idade": 30, "sexo": "M"} for i in range(1000)]

    tempo_atual = 0.0
    contadorDoentes = 0
    queueEventos = []
    queue = []
    
    # Médico: [id, ocupado, doente_corrente, total_tempo_ocupado, inicio_consulta]
    medicos = [[f"m{i}", False, None, 0.0, 0.0] for i in range(num_medicos)]
    
    chegadas = {}
    tempos_espera, tempos_consulta, tempos_total_clinica = [], [], []
    timeline_tempo, timeline_fila, timeline_ocupa = [], [], []

    # Gerar chegadas (Poisson)
    t_chegada = gera_proxima_chegada_poisson(taxa_chegada)
    while t_chegada < tempo_simulacao and contadorDoentes < len(lista_pessoas):
        nome = lista_pessoas[contadorDoentes]['nome']
        chegadas[nome] = t_chegada
        queueEventos = enqueue(queueEventos, (t_chegada, CHEGADA, nome))
        t_chegada += gera_proxima_chegada_poisson(taxa_chegada)
        contadorDoentes += 1

    # Ciclo de Simulação
    while queueEventos:
        evento, queueEventos = dequeue(queueEventos)
        tempo_atual, tipo, doente = evento

        # Logs para gráficos
        ocs = sum(1 for m in medicos if m[1])
        timeline_tempo.append(tempo_atual); timeline_fila.append(len(queue)); timeline_ocupa.append(ocs/num_medicos)

        if tipo == CHEGADA:
            medico_livre = next((m for m in medicos if not m[1]), None)
            if medico_livre:
                medico_livre[1] = True; medico_livre[2] = doente; medico_livre[4] = tempo_atual
                tempos_espera.append(tempo_atual - chegadas[doente])
                t_cons = gera_tempo_consulta(tempo_medio_consulta, dist_tempo_consulta)
                tempos_consulta.append(t_cons)
                queueEventos = enqueue(queueEventos, (tempo_atual + t_cons, SAIDA, doente))
            else:
                queue.append((doente, tempo_atual))

        elif tipo == SAIDA:
            for m in medicos:
                if m[2] == doente:
                    m[3] += (tempo_atual - m[4]); m[1] = False; m[2] = None
                    tempos_total_clinica.append(tempo_atual - chegadas[doente])
                    if queue:
                        prox_nome, _ = queue.pop(0)
                        m[1] = True; m[2] = prox_nome; m[4] = tempo_atual
                        tempos_espera.append(tempo_atual - chegadas[prox_nome])
                        t_cons = gera_tempo_consulta(tempo_medio_consulta, dist_tempo_consulta)
                        tempos_consulta.append(t_cons)
                        queueEventos = enqueue(queueEventos, (tempo_atual + t_cons, SAIDA, prox_nome))
                    break

    stats = {
        "doentes_atendidos": len(tempos_total_clinica),
        "tempo_medio_espera": np.mean(tempos_espera) if tempos_espera else 0,
        "tempo_medio_consulta": np.mean(tempos_consulta) if tempos_consulta else 0,
        "tempo_medio_total_clinica": np.mean(tempos_total_clinica) if tempos_total_clinica else 0,
        "tamanho_medio_fila": np.mean(timeline_fila) if timeline_fila else 0,
        "tamanho_max_fila": max(timeline_fila) if timeline_fila else 0,
        "ocupacao_medicos": [m[3] / tempo_simulacao for m in medicos]
    }
    return stats, {"tempo": timeline_tempo, "tamanho_fila": timeline_fila, "ocupacao_medicos": timeline_ocupa}




# config.py
NUM_MEDICOS_DEFAULT = 3
TAXA_CHEGADA_DEFAULT = 10 / 60
TEMPO_MEDIO_CONSULTA_DEFAULT = 15
TEMPO_SIMULACAO_DEFAULT = 8 * 60
DISTRIBUICAO_TEMPO_CONSULTA_DEFAULT = "exponential"

import numpy as np
import json
import os

# Constantes
CHEGADA = "chegada"
SAIDA = "saída"

# --- Funções de Suporte ---
def e_tempo(e): return e[0]
def e_tipo(e): return e[1]
def e_doente(e): return e[2]

def procuraPosQueue(q, t):
    i = 0
    while i < len(q) and t > q[i][0]: i += 1
    return i

def enqueue(q, e):
    pos = procuraPosQueue(q, e[0])
    return q[:pos] + [e] + q[pos:]

def dequeue(q):
    return q[0], q[1:]

def mOcupa(m):
    m[1] = not m[1]
    return m

def gera_proxima_chegada_poisson(taxa_lmbda):
    return np.random.exponential(1.0 / taxa_lmbda)

def gera_tempo_consulta(mean_service_time, dist):
    if dist == "exponential": return np.random.exponential(mean_service_time)
    elif dist == "normal": return max(1, np.random.normal(mean_service_time, mean_service_time / 3))
    return mean_service_time

# --- Função Principal ---
def simula(num_medicos, taxa_chegada, tempo_medio_consulta, tempo_simulacao, dist_tempo_consulta="exponential", caminho_json="pessoas (1).json", debug=False):
    
    # Carregar JSON com verificação de erro
    if os.path.exists(caminho_json):
        with open(caminho_json, 'r', encoding='utf-8') as f:
            lista_pessoas = json.load(f)
    else:
        print(f"AVISO: Ficheiro {caminho_json} não encontrado! A usar nomes genéricos.")
        lista_pessoas = [{"nome": f"Doente_{i}", "idade": 30, "sexo": "M"} for i in range(1000)]

    tempo_atual = 0.0
    contadorDoentes = 0
    queueEventos = []
    queue = []
    
    # Médico: [id, ocupado, doente_corrente, total_tempo_ocupado, inicio_consulta]
    medicos = [[f"m{i}", False, None, 0.0, 0.0] for i in range(num_medicos)]
    
    chegadas = {}
    tempos_espera, tempos_consulta, tempos_total_clinica = [], [], []
    timeline_tempo, timeline_fila, timeline_ocupa = [], [], []

    # Gerar chegadas (Poisson)
    t_chegada = gera_proxima_chegada_poisson(taxa_chegada)
    while t_chegada < tempo_simulacao and contadorDoentes < len(lista_pessoas):
        nome = lista_pessoas[contadorDoentes]['nome']
        chegadas[nome] = t_chegada
        queueEventos = enqueue(queueEventos, (t_chegada, CHEGADA, nome))
        t_chegada += gera_proxima_chegada_poisson(taxa_chegada)
        contadorDoentes += 1

    # Ciclo de Simulação
    while queueEventos:
        evento, queueEventos = dequeue(queueEventos)
        tempo_atual, tipo, doente = evento

        # Logs para gráficos
        ocs = sum(1 for m in medicos if m[1])
        timeline_tempo.append(tempo_atual); timeline_fila.append(len(queue)); timeline_ocupa.append(ocs/num_medicos)

        if tipo == CHEGADA:
            medico_livre = next((m for m in medicos if not m[1]), None)
            if medico_livre:
                medico_livre[1] = True; medico_livre[2] = doente; medico_livre[4] = tempo_atual
                tempos_espera.append(tempo_atual - chegadas[doente])
                t_cons = gera_tempo_consulta(tempo_medio_consulta, dist_tempo_consulta)
                tempos_consulta.append(t_cons)
                queueEventos = enqueue(queueEventos, (tempo_atual + t_cons, SAIDA, doente))
            else:
                queue.append((doente, tempo_atual))

        elif tipo == SAIDA:
            for m in medicos:
                if m[2] == doente:
                    m[3] += (tempo_atual - m[4]); m[1] = False; m[2] = None
                    tempos_total_clinica.append(tempo_atual - chegadas[doente])
                    if queue:
                        prox_nome, _ = queue.pop(0)
                        m[1] = True; m[2] = prox_nome; m[4] = tempo_atual
                        tempos_espera.append(tempo_atual - chegadas[prox_nome])
                        t_cons = gera_tempo_consulta(tempo_medio_consulta, dist_tempo_consulta)
                        tempos_consulta.append(t_cons)
                        queueEventos = enqueue(queueEventos, (tempo_atual + t_cons, SAIDA, prox_nome))
                    break

    stats = {
        "doentes_atendidos": len(tempos_total_clinica),
        "tempo_medio_espera": np.mean(tempos_espera) if tempos_espera else 0,
        "tempo_medio_consulta": np.mean(tempos_consulta) if tempos_consulta else 0,
        "tempo_medio_total_clinica": np.mean(tempos_total_clinica) if tempos_total_clinica else 0,
        "tamanho_medio_fila": np.mean(timeline_fila) if timeline_fila else 0,
        "tamanho_max_fila": max(timeline_fila) if timeline_fila else 0,
        "ocupacao_medicos": [m[3] / tempo_simulacao for m in medicos]
    }
    return stats, {"tempo": timeline_tempo, "tamanho_fila": timeline_fila, "ocupacao_medicos": timeline_ocupa}




import FreeSimpleGUI as sg

from clinic import simula
from config import (
    NUM_MEDICOS_DEFAULT,
    TAXA_CHEGADA_DEFAULT,
    TEMPO_MEDIO_CONSULTA_DEFAULT,
    TEMPO_SIMULACAO_DEFAULT,
    DISTRIBUICAO_TEMPO_CONSULTA_DEFAULT,
)

# -------------------------------
# Valores iniciais
# -------------------------------
num_medicos = NUM_MEDICOS_DEFAULT
taxa_chegada_hora = 10.0
tempo_medio_consulta = TEMPO_MEDIO_CONSULTA_DEFAULT
tempo_simulacao = TEMPO_SIMULACAO_DEFAULT
dist_consulta = DISTRIBUICAO_TEMPO_CONSULTA_DEFAULT


def formata_resultados(stats):
    linhas = []
    linhas.append(f"Doentes atendidos: {stats['doentes_atendidos']:.0f}")
    linhas.append(f"Tempo médio de espera (min): {stats['tempo_medio_espera']:.2f}")
    linhas.append(f"Tempo médio de consulta (min): {stats['tempo_medio_consulta']:.2f}")
    linhas.append(f"Tempo médio na clínica (min): {stats['tempo_medio_total_clinica']:.2f}")
    linhas.append(f"Tamanho médio da fila: {stats['tamanho_medio_fila']:.2f}")
    linhas.append(f"Tamanho máximo da fila: {stats['tamanho_max_fila']}")
    linhas.append("Ocupação dos médicos:")
    for i, occ in enumerate(stats["ocupacao_medicos"]):
        linhas.append(f"  Médico m{i}: {occ*100:.1f}%")
    return "\n".join(linhas)


# -------------------------------
# Layout da interface
# -------------------------------
layout = [
    [sg.Text("Parâmetros da simulação", font=("Arial", 12, "bold"))],

    [sg.Text("Número de médicos:", size=(25, 1)),
     sg.Input(str(num_medicos), key="-MEDICOS-")],

    [sg.Text("Taxa de chegada (doentes/hora):", size=(25, 1)),
     sg.Input(str(taxa_chegada_hora), key="-TAXA-")],

    [sg.Text("Tempo médio de consulta (min):", size=(25, 1)),
     sg.Input(str(tempo_medio_consulta), key="-CONSULTA-")],

    [sg.Text("Tempo total de simulação (min):", size=(25, 1)),
     sg.Input(str(tempo_simulacao), key="-SIMULACAO-")],

    [sg.Text("Distribuição do tempo de consulta:")],
    [
        sg.Radio("Exponencial", "DIST", key="-EXP-", default=(dist_consulta=="exponential")),
        sg.Radio("Normal", "DIST", key="-NORM-", default=(dist_consulta=="normal")),
        sg.Radio("Uniforme", "DIST", key="-UNIF-", default=(dist_consulta=="uniform")),
    ],

    [sg.Button("Executar simulação", key="-RUN-", size=(20, 1))],

    [sg.Text("Resultados:", font=("Arial", 12, "bold"))],
    [sg.Multiline("Resultados aparecerão aqui.",
                  size=(70, 15),
                  key="-OUT-",
                  disabled=True)],
]

window = sg.Window("Simulação Clínica Médica", layout)


# -------------------------------
# Loop principal
# -------------------------------
while True:
    event, values = window.read()

    if event == sg.WIN_CLOSED:
        break

    if event == "-RUN-":
        try:
            num_medicos = int(values["-MEDICOS-"])
            taxa_chegada_hora = float(values["-TAXA-"])
            tempo_medio_consulta = float(values["-CONSULTA-"])
            tempo_simulacao = float(values["-SIMULACAO-"])

            if values["-EXP-"]:
                dist_consulta = "exponential"
            elif values["-NORM-"]:
                dist_consulta = "normal"
            else:
                dist_consulta = "uniform"

            taxa_minuto = taxa_chegada_hora / 60.0

            stats, _ = simula(
                num_medicos=num_medicos,
                taxa_chegada=taxa_minuto,
                tempo_medio_consulta=tempo_medio_consulta,
                tempo_simulacao=tempo_simulacao,
                dist_tempo_consulta=dist_consulta,
                debug=False,
            )

            window["-OUT-"].update(formata_resultados(stats))

        except Exception as e:
            window["-OUT-"].update(f"ERRO NA SIMULAÇÃO:\n{e}")

window.close()




# plots.py
import numpy as np
import matplotlib.pyplot as plt

from clinic import simula
from config import (
    NUM_MEDICOS_DEFAULT,
    TAXA_CHEGADA_DEFAULT,
    TEMPO_MEDIO_CONSULTA_DEFAULT,
    TEMPO_SIMULACAO_DEFAULT,
    DISTRIBUICAO_TEMPO_CONSULTA_DEFAULT,
)

# ---------------------------------------------------------
# 1. Gráfico: Evolução do tamanho da fila ao longo do tempo
# ---------------------------------------------------------
def grafico_fila_tempo():
    stats, timeline = simula(
        num_medicos=NUM_MEDICOS_DEFAULT,
        taxa_chegada=TAXA_CHEGADA_DEFAULT,
        tempo_medio_consulta=TEMPO_MEDIO_CONSULTA_DEFAULT,
        tempo_simulacao=TEMPO_SIMULACAO_DEFAULT,
        dist_tempo_consulta=DISTRIBUICAO_TEMPO_CONSULTA_DEFAULT,
        debug=False,
    )

    t = timeline["tempo"]
    fila = timeline["tamanho_fila"]

    plt.figure()
    plt.plot(t, fila, label="Tamanho da fila")
    plt.xlabel("Tempo (min)")
    plt.ylabel("Número de doentes em espera")
    plt.title("Evolução do tamanho da fila ao longo do tempo")
    plt.legend()
    plt.grid(True)
    plt.show()

# ---------------------------------------------------------
# 2. Gráfico: Ocupação dos médicos ao longo do tempo
# ---------------------------------------------------------
def grafico_ocupacao_tempo():
    stats, timeline = simula(
        num_medicos=NUM_MEDICOS_DEFAULT,
        taxa_chegada=TAXA_CHEGADA_DEFAULT,
        tempo_medio_consulta=TEMPO_MEDIO_CONSULTA_DEFAULT,
        tempo_simulacao=TEMPO_SIMULACAO_DEFAULT,
        dist_tempo_consulta=DISTRIBUICAO_TEMPO_CONSULTA_DEFAULT,
        debug=False,
    )

    t = timeline["tempo"]
    occ = [x * 100 for x in timeline["ocupacao_medicos"]]

    plt.figure()
    plt.plot(t, occ, label="Ocupação (%)")
    plt.xlabel("Tempo (min)")
    plt.ylabel("Ocupação dos médicos (%)")
    plt.title("Evolução da ocupação dos médicos ao longo do tempo")
    plt.legend()
    plt.grid(True)
    plt.show()

# ---------------------------------------------------------
# 3. Gráfico: Tamanho médio da fila vs taxa de chegada
# ---------------------------------------------------------
def grafico_fila_vs_taxa_chegada():
    taxas = np.arange(10, 31, 2)  # 10 a 30 doentes/hora
    tamanhos_medios = []

    for taxa_hora in taxas:
        taxa_minuto = taxa_hora / 60
        stats, _ = simula(
            num_medicos=NUM_MEDICOS_DEFAULT,
            taxa_chegada=taxa_minuto,
            tempo_medio_consulta=TEMPO_MEDIO_CONSULTA_DEFAULT,
            tempo_simulacao=TEMPO_SIMULACAO_DEFAULT,
            dist_tempo_consulta=DISTRIBUICAO_TEMPO_CONSULTA_DEFAULT,
            debug=False,
        )
        tamanhos_medios.append(stats["tamanho_medio_fila"])

    plt.figure()
    plt.plot(taxas, tamanhos_medios, marker="o")
    plt.xlabel("Taxa de chegada de doentes (doentes/hora)")
    plt.ylabel("Tamanho médio da fila")
    plt.title("Tamanho médio da fila vs taxa de chegada")
    plt.grid(True)
    plt.show()

# ---------------------------------------------------------
# Execução direta (opcional)
# ---------------------------------------------------------
if _name_ == "_main_":
    grafico_fila_tempo()
    grafico_ocupacao_tempo()
    grafico_fila_vs_taxa_chegada()



from clinic import simula
from config import (
    NUM_MEDICOS_DEFAULT,
    TAXA_CHEGADA_DEFAULT,
    TEMPO_MEDIO_CONSULTA_DEFAULT,
    TEMPO_SIMULACAO_DEFAULT,
    DISTRIBUICAO_TEMPO_CONSULTA_DEFAULT,
)

def run_single_simulation():
    stats, _ = simula(
        num_medicos=NUM_MEDICOS_DEFAULT,
        taxa_chegada=TAXA_CHEGADA_DEFAULT,
        tempo_medio_consulta=TEMPO_MEDIO_CONSULTA_DEFAULT,
        tempo_simulacao=TEMPO_SIMULACAO_DEFAULT,
        dist_tempo_consulta=DISTRIBUICAO_TEMPO_CONSULTA_DEFAULT,
        debug=False,
    )

    print("=== Resultados da simulação ===")
    print(f"Doentes atendidos: {stats['doentes_atendidos']:.0f}")
    print(f"Tempo médio de espera (min): {stats['tempo_medio_espera']:.2f}")
    print(f"Tempo médio de consulta (min): {stats['tempo_medio_consulta']:.2f}")
    print(f"Tempo médio total na clínica (min): {stats['tempo_medio_total_clinica']:.2f}")
    print(f"Tamanho médio da fila: {stats['tamanho_medio_fila']:.2f}")
    print(f"Tamanho máximo da fila: {stats['tamanho_max_fila']}")
    print("Ocupação dos médicos:")
    for i, occ in enumerate(stats["ocupacao_medicos"]):
        print(f"  Médico m{i}: {occ*100:.1f}%")

if _name_ == "_main_":
    run_single_simulation()
